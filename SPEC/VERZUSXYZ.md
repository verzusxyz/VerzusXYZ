# VerzusXYZ — Final Master Spec

Project name: VerzusXYZ
Platforms: Flutter (Android, iOS, Web, Desktop)
Backend: Firebase (Auth, Firestore, Storage, Cloud Functions)
Base currency: USD with local-currency estimates in UI

This document is the canonical spec for the VerzusXYZ product and mirrors the requirements you provided, organized for engineering handoff. It is paired with ACCEPTANCE.md for QA.

1. Product overview & core distinctions
- A. Matches — 1v1 / small multiplayer sessions. User-created or join. Stakes flexible (user sets amount). Auto-proof, verification, payouts.
- B. Tournaments — Auto (fixed tiers $5, $10, $25, $50; bracket size 12) and Manual/Organizer (custom entry and rules). Auto-spawn next bracket when full.
- C. Topics (Polls/Predictions) — Verified (with verification link; auto-resolution) and Open (community-voted). Users stake on outcomes; pooled payouts.
- D. Live Betting / Spectator Pools — Spectators stake on ongoing matches or tournament rounds with dynamic odds (parimutuel). Platform takes cut; winners share remaining pool.

2. Fixed fee tiers & where they apply
- Auto Tournaments: fixed entry tiers $5, $10, $25, $50.
- All other items (matches, manual tournaments, topics, spectator pools): user-entered amounts within min/max (default min $1, max $500; admin configurable).
- UI shows local-currency estimates for deposits and entries.

3. Platform commission & fees (defaults; admin-configurable)
- Matches: 20% of total pot.
- Tournaments (auto/manual): 23% of total pot.
- Live Betting pools: 20% of pool.
- Topics pools: 20% of pool.
- Gateway fees: explicit, shown separately; deducted at deposit time and net credited (recommended approach A).
- Affiliate payout is paid out of platform commission pool (see section 4).

4. Affiliate program — final rules
- Affiliate payout: 1% of the platform commission generated by the referred user’s FIRST used amount (not of the used amount itself).
- Applies once per referred user (first time funds are locked into a match/tournament/topic).
- Credited to wallets[affiliateId].affiliatePending and becomes withdrawable after threshold (default $20).
- Admin can adjust percentage; default 1%.
- Worked examples:
  - A: Referred first used $10 in a match → commission 20% = $2.00 → affiliate payout 1% of $2.00 = $0.02.
  - B: Referred first used $60 → commission $12 → affiliate payout $0.12.
- Admin UI: referrals collection with fields {referrerId, referredId, firstUsedAmount, affiliatePayout, paidOut, createdAt}. Configurable thresholds.

5. Game addition — complete client/server flow
Client
- Add Game screen with buttons: Detect Installed Games (Android), Use ReplayKit (iOS), Add Web Game (URL), Manual Add.
- Android: request permissions; list installed games; capture 3–6 frames with MediaProjection; on-device TFLite proposes defaultCropData (scoreRect, usernameRect). User can adjust and accept.
- iOS: ReplayKit-based sample capture and same crop suggestion flow.
- Web: Accept game URL; optional getDisplayMedia capture; same crop suggestion flow.
- Manual Add: form with icon upload + manual crop tool.
- On accept: upload samples to Storage and submission doc to games_user_submissions with defaultCropData, ocrCandidates, cropConfidence.

Server & Admin
- onGameSubmission Cloud Function: canonicalize game key (android:pkg, ios:bundle, web:url), dedupe, enqueue in games_pending_review.
- Auto-promote if cropConfidence >= 0.90 and 3+ unique submitters and 2+ ocr candidate matches; else admin review.
- Admin Review UI: show samples, crops, OCR candidates, stats; actions: Approve & Promote, Edit Crop, Reject, Merge.
- On approve: write games/{gameId} with defaultCropData and metadata; index keywords.

6. Matches — create/join/play/auto-proof/verify/finalize
Client
- Create Match form: game dropdown, match type, stake, visibility (open/invite), start (auto when full/schedule). Write matches_temp then call createMatch function to validate and create authoritative match.
- Join Match: confirm lock; if insufficient funds, prompt Deposit.
- Play: capture frames with defaultCropData; extract OCR; buffer session.
- End: upload final proof images to Storage and update match proofUploads and candidate_end status.

Server
- createMatch: validate (KYC, stake min/max, invite). Create matches doc; if policy chosen, lock creator stake.
- joinMatch: transaction that reduces balance, increases locked, writes stake tx; append player and stake; set funded when full.
- verifyMatchProof: OCR, username mapping (see section 11), risk scoring; thresholds → auto-finalize, confirm, or dispute.
- finalizeMatch: atomic distribution: commission, prizePool, wallet debits/credits, transactions, admin_financials, affiliate first-used credit, and ELO update.

7. Live betting (spectator) — pooled parimutuel
- placeStake(eventId, optionId, amount): lock funds and append stake; update pools totals and implied odds in realtime.
- finalizePool: compute winning option, platform cut (20%), payout pool. Winners share proportionally; update wallets and transactions. Admin_financials += platform cut minus affiliate payouts.

8. Tournaments — 12-player auto brackets & payout examples
- Join: joinTournament locks entry fee, appends participant; startTournament seeds bracket by ELO and sets in_progress.
- Payouts examples for 12 players:
  - $5: total $60, commission 23% = $13.80, prize $46.20 → 1st $27.72, 2nd $11.55, 3rd $6.93.
  - $10: total $120, commission $27.60, prize $92.40 → 1st $55.44, 2nd $23.10, 3rd $13.86.
  - $25: total $300, commission $69.00, prize $231.00 → 1st $138.60, 2nd $57.75, 3rd $34.65.
  - $50: total $600, commission $138.00, prize $462.00 → 1st $277.20, 2nd $115.50, 3rd $69.30.
- Auto-spawn next bracket when full for auto tournaments.

9. Topics — verified and open
- Verified: supply verification link; server resolves outcome at close; platform cut 20%; proportional payouts.
- Open: close time; option with highest stake or votes wins; same settlement mechanics.
- UI shows verification link, odds, pool distribution, countdown.

10. Wallets, deposits, gateway fees, float, escrow, safe-withdrawable
- Wallets: wallets/{uid} {balance, locked (pendingBalance), affiliatePending, loyaltyPoints, currency, updatedAt}.
- Deposits: createPayment function issues gateway token; webhook verifies and credits net (gross - gatewayFee). Transaction logged.
- Locking: server-side atomic transactions; balance -= amount; locked += amount.
- Withdrawals: write withdrawals doc; server validates float & safeWithdrawable, initiates payout; webhook confirms and updates wallet.
- Fees: Gateway fees deducted at deposit, stored on payments; prize pools based on net credits (avoid double dip).
- Safe-withdrawable formula: safeWithdrawable = availableBalance - pendingPayouts - contingencyReserve - lockedPrizePools.

11. Verification, anti-cheat, username matching
- Username matching: normalize, combine Jaro-Winkler + Levenshtein, context boosts, thresholds (>=0.92 auto; 0.85–0.92 tentative; 0.70–0.85 confirm; <0.70 review).
- Anti-cheat risk score factors: score jumps, repeat opponents, duration vs typical length, tamper detection, device flags. Thresholds (<0.10 auto, 0.10–0.60 review, >=0.60 dispute).

Same-room detection (critical)
- Multi-signal approach: URL/external match ID, OCR room code, user-shared link, Verzus session token/QR, board-state fingerprinting (FEN for board games), pHash similarity + timestamps, third-party API where allowed.
- Evidence scoring: evidenceScore = 0.35*urlMatch + 0.25*boardState + 0.15*phash + 0.15*username + 0.10*timeCorrelation. Thresholds: >=0.92 auto; 0.70–0.92 confirm/admin; <0.70 dispute.
- Store externalIds, sessionToken, boardHash, evidenceScore on matches; verifications/{id} contains signals and final verdict.

12. ELO & matchmaking
- Initial 1200. K-factors: <1400 → 40; 1400–2399 → 20; >=2400 → 10.
- Queue expands ±100 then +50 every 5s up to ±600; region preference; offer timeout 20s.
- Record elo_history.

13. UI/UX specifics
- Web landing with hero, Auto tournaments carousel, live feed, topic highlights, footer.
- Mobile onboarding walkthrough (3 screens). Shimmer placeholders and global loader (lottie) used; accessible colors; respects reduced motion.

14. Cloud Functions (authoritative)
- createPayment, onGatewayWebhook, createMatch, joinMatch, verifyMatchProof, finalizeMatch, placeStake, finalizePool, joinTournament, startTournament, finalizeTournament, generateAutoTournaments, computeSafeWithdrawable, affiliateCreditOnFirstUsed, applyOffer, promoteGameSubmission, massPayoutJob, reconcilePayments.
- Same-room helpers: parseExternalIdFromUrl, extractRoomIdFromOCR, computeBoardFENFromImage, computeEvidenceScore.

15. Firestore data model (canonical snippets)
- users/{uid}: {displayName, email, username, country, phone, kycStatus, createdAt, ...}
- wallets/{uid}: {balance, pendingBalance(locked), affiliatePending, loyaltyPoints, currency, updatedAt, totals}
- payments/{id}: {gateway, grossAmount, gatewayFee, netAmount, status, orderId, userId}
- matches/{id}: {gameId, players, stakeAmounts, status, mode, proofUploads, externalIds, sessionToken, boardHash, evidenceScore, ...}
- tournaments/{id}, pools/{eventId}, affiliates/{id}, verifications/{id}, transactions/{txId}, admin_financials/main, referrals/{id}, games_{*}

16. Acceptance criteria & QA checklist — see ACCEPTANCE.md

17. Edge cases & disputes
- Disconnects mid-match, ties, fraud holds (riskScore >= 0.6), affiliate abuse detection and reversal.

18. Operational & compliance
- Language: challenge/contribution/reward/prediction (avoid bet/gamble). KYC for live and withdrawals. Country gateway toggles. Audit logs, privacy, proof retention 30 days.

19. Deliverables
- This spec, acceptance tests, Firestore schema and rules, Indexes list, Cloud Functions manifest & templates, Flutter app scaffold (auth, games, capture hooks, matches, pools, tournaments, wallet, admin), Admin UI scaffolding, Postman collection (webhook sims), UX mockups.

20. Immediate arithmetic examples
- Match: 2x $10 → total $20; commission 20%=$4; prizePool=$16; winner gets $16; transactions reflect lock/refund/payout/commission.
- Auto Tournament $25: total $300; commission $69; prize $231 → 1st $138.60; 2nd $57.75; 3rd $34.65.
- Affiliate example: referred first-used $10 → commission $2 → affiliate $0.02.

Notes
- Secrets (Paystack/Flutterwave) must stay on server functions. Client uses public keys only, and calls callable HTTPS functions for live payments.
- Gateway fees recommended to be deducted at deposit; pools operate on net balances. If policy differs, document adjustments in transactions.
